{% extends 'base.html' %}

{% block title %}{{ page_title }} - Pass-Man{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between mb-8">
        <div class="min-w-0 flex-1">
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">{{ page_title }}</h2>
            <p class="mt-1 text-sm text-gray-500">
                {% if is_create %}
                    Create a new secure password entry
                {% else %}
                    Update password information and security settings
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Form -->
    <div class="bg-white shadow sm:rounded-lg">
        <form method="post" id="passwordForm" class="space-y-8 divide-y divide-gray-200 p-8">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="space-y-6">
                <div>
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Basic Information</h3>
                    <p class="mt-1 text-sm text-gray-500">Essential details for this password entry.</p>
                </div>

                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                    <div class="sm:col-span-3">
                        <label for="title" class="block text-sm font-medium leading-6 text-gray-900">Title <span class="text-red-500">*</span></label>
                        <div class="mt-2">
                            <input type="text" name="title" id="title" required value="{% if password %}{{ password.title }}{% elif form_data.title %}{{ form_data.title }}{% endif %}" class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6" placeholder="e.g., Gmail Account">
                        </div>
                        {% if errors.title %}
                            <p class="mt-2 text-sm text-red-600">{{ errors.title.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="sm:col-span-3">
                        <label for="username" class="block text-sm font-medium leading-6 text-gray-900">Username / Email</label>
                        <div class="mt-2">
                            <input type="text" name="username" id="username" value="{% if password %}{{ password.username }}{% elif form_data.username %}{{ form_data.username }}{% endif %}" class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6" placeholder="username or email@example.com">
                        </div>
                        {% if errors.username %}
                            <p class="mt-2 text-sm text-red-600">{{ errors.username.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="sm:col-span-6">
                        <label for="password" class="block text-sm font-medium leading-6 text-gray-900">Password {% if is_create %}<span class="text-red-500">*</span>{% endif %}</label>
                        <div class="relative mt-2 rounded-md shadow-sm">
                            <input type="password" name="password" id="password" {% if is_create %}required{% endif %} class="block w-full rounded-md border-0 py-1.5 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6" placeholder="{% if is_create %}Enter secure password{% else %}Leave blank to keep current password{% endif %}">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <button type="button" class="text-gray-400 hover:text-gray-500 focus:outline-none" onclick="togglePasswordVisibility('password')">
                                    <span class="sr-only">Show password</span>
                                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" id="password-icon">
                                        <path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" />
                                        <path fill-rule="evenodd" d="M.664 10.59a1.651 1.651 0 010-1.186A10.004 10.004 0 0110 3c4.257 0 7.893 2.66 9.336 6.41.147.381.146.804 0 1.186A10.004 10.004 0 0110 17c-4.257 0-7.893-2.66-9.336-6.41zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        {% if errors.password %}
                            <p class="mt-2 text-sm text-red-600">{{ errors.password.0 }}</p>
                        {% endif %}

                        <!-- Password Strength -->
                        <div class="mt-2">
                            <div class="h-1 w-full bg-gray-200 rounded-full overflow-hidden">
                                <div id="strengthFill" class="h-full bg-red-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p id="strengthText" class="mt-1 text-xs text-gray-500">Password strength will appear here</p>
                        </div>

                        <!-- Password Generator Toggle -->
                        <div class="mt-4">
                            <button type="button" onclick="toggleGenerator()" class="inline-flex items-center gap-x-1.5 text-sm font-semibold text-primary-600 hover:text-primary-500">
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM6.75 9.25a.75.75 0 000 1.5h4.59l-2.1 1.95a.75.75 0 001.02 1.1l3.5-3.25a.75.75 0 000-1.1l-3.5-3.25a.75.75 0 10-1.02 1.1l2.1 1.95H6.75z" clip-rule="evenodd" />
                                </svg>
                                Toggle Password Generator
                            </button>
                        </div>

                        <!-- Generator Controls -->
                        <div id="generatorControls" class="hidden mt-4 p-4 bg-gray-50 rounded-md border border-gray-200">
                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Length</label>
                                    <input type="number" id="genLength" value="16" min="8" max="128" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                                </div>
                                <div class="sm:col-span-2 space-y-2">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="genUppercase" checked class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-600">
                                        <label for="genUppercase" class="ml-2 block text-sm text-gray-900">Uppercase (A-Z)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="genLowercase" checked class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-600">
                                        <label for="genLowercase" class="ml-2 block text-sm text-gray-900">Lowercase (a-z)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="genNumbers" checked class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-600">
                                        <label for="genNumbers" class="ml-2 block text-sm text-gray-900">Numbers (0-9)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="genSymbols" checked class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-600">
                                        <label for="genSymbols" class="ml-2 block text-sm text-gray-900">Symbols (!@#$)</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <button type="button" onclick="generatePassword()" class="inline-flex justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                                    Generate Password
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="sm:col-span-6">
                        <label for="url" class="block text-sm font-medium leading-6 text-gray-900">Website / URL</label>
                        <div class="mt-2">
                            <input type="url" name="url" id="url" value="{% if password %}{{ password.url }}{% elif form_data.url %}{{ form_data.url }}{% endif %}" class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6" placeholder="https://example.com">
                        </div>
                        {% if errors.url %}
                            <p class="mt-2 text-sm text-red-600">{{ errors.url.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Organization -->
            <div class="pt-8 space-y-6">
                <div>
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Organization</h3>
                    <p class="mt-1 text-sm text-gray-500">Categorize and prioritize this entry.</p>
                </div>

                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                    <div class="sm:col-span-3">
                        <label for="group_id" class="block text-sm font-medium leading-6 text-gray-900">Group <span class="text-red-500">*</span></label>
                        <div class="mt-2">
                            <select id="group_id" name="group_id" required {% if not is_create %}disabled{% endif %} class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
                                <option value="">Select a group</option>
                                {% for group in user_groups %}
                                    <option value="{{ group.id }}" {% if password and password.group.id == group.id %}selected{% elif form_data.group_id == group.id|stringformat:"s" %}selected{% endif %}>{{ group.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% if errors.group_id %}
                            <p class="mt-2 text-sm text-red-600">{{ errors.group_id.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="sm:col-span-3">
                        <label for="priority" class="block text-sm font-medium leading-6 text-gray-900">Priority</label>
                        <div class="mt-2">
                            <select id="priority" name="priority" class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">
                                {% for value, label in priority_choices %}
                                    <option value="{{ value }}" {% if password and password.priority == value %}selected{% elif form_data.priority == value %}selected{% elif value == "medium" and not password and not form_data.priority %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="sm:col-span-6">
                        <label for="tags" class="block text-sm font-medium leading-6 text-gray-900">Tags</label>
                        <div class="mt-2">
                            <input type="text" name="tags" id="tags" value="{% if tags_str %}{{ tags_str }}{% elif form_data.tags %}{{ form_data.tags|join:", " }}{% endif %}" class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6" placeholder="work, email, social">
                        </div>
                        <p class="mt-2 text-sm text-gray-500">Separate tags with commas.</p>
                    </div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="pt-8 space-y-6">
                <div>
                    <h3 class="text-base font-semibold leading-6 text-gray-900">Additional Information</h3>
                    <p class="mt-1 text-sm text-gray-500">Notes and custom fields.</p>
                </div>

                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                    <div class="sm:col-span-6">
                        <label for="notes" class="block text-sm font-medium leading-6 text-gray-900">Notes</label>
                        <div class="mt-2">
                            <textarea id="notes" name="notes" rows="3" class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6">{% if password %}{{ password.notes }}{% elif form_data.notes %}{{ form_data.notes }}{% endif %}</textarea>
                        </div>
                    </div>

                    <div class="sm:col-span-6">
                        <label class="block text-sm font-medium leading-6 text-gray-900">Custom Fields</label>
                        <div class="mt-2 space-y-4" id="customFieldsContainer">
                            <!-- Custom fields will be populated by JavaScript -->
                        </div>
                        <button type="button" onclick="addCustomField()" class="mt-4 inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                            + Add Custom Field
                        </button>
                        <input type="hidden" id="custom_fields" name="custom_fields" value="{% if custom_fields_str %}{{ custom_fields_str }}{% elif form_data.custom_fields %}{{ form_data.custom_fields|default:"{}" }}{% else %}{}{% endif %}">
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="pt-8 flex justify-end gap-x-3">
                <a href="{% if password %}{% url 'passwords:detail' password.id %}{% else %}{% url 'passwords:list' %}{% endif %}" class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Cancel</a>
                <button type="submit" class="rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary-600">
                    {% if is_create %}Create Password{% else %}Update Password{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let customFieldCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    loadCustomFields();
    
    const passwordInput = document.getElementById('password');
    passwordInput.addEventListener('input', checkPasswordStrength);
});

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
    } else {
        input.type = 'password';
    }
}

function toggleGenerator() {
    const controls = document.getElementById('generatorControls');
    controls.classList.toggle('hidden');
}

function generatePassword() {
    const length = document.getElementById('genLength').value;
    const includeUppercase = document.getElementById('genUppercase').checked;
    const includeLowercase = document.getElementById('genLowercase').checked;
    const includeNumbers = document.getElementById('genNumbers').checked;
    const includeSymbols = document.getElementById('genSymbols').checked;
    
    // Simple client-side generation for immediate feedback
    const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const lowercase = 'abcdefghijklmnopqrstuvwxyz';
    const numbers = '0123456789';
    const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
    
    let chars = '';
    if (includeUppercase) chars += uppercase;
    if (includeLowercase) chars += lowercase;
    if (includeNumbers) chars += numbers;
    if (includeSymbols) chars += symbols;
    
    if (!chars) {
        alert('Please select at least one character type.');
        return;
    }
    
    let password = '';
    for (let i = 0; i < length; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    
    document.getElementById('password').value = password;
    checkPasswordStrength();
}

function checkPasswordStrength() {
    const password = document.getElementById('password').value;
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    
    if (!password) {
        strengthFill.style.width = '0%';
        strengthText.textContent = 'Password strength will appear here';
        return;
    }
    
    let score = 0;
    if (password.length >= 8) score += 20;
    if (password.length >= 12) score += 20;
    if (/[A-Z]/.test(password)) score += 15;
    if (/[a-z]/.test(password)) score += 15;
    if (/[0-9]/.test(password)) score += 15;
    if (/[^A-Za-z0-9]/.test(password)) score += 15;
    
    score = Math.min(100, score);
    
    let color = 'bg-red-500';
    let text = 'Weak';
    
    if (score >= 80) {
        color = 'bg-green-500';
        text = 'Very Strong';
    } else if (score >= 60) {
        color = 'bg-blue-500';
        text = 'Strong';
    } else if (score >= 40) {
        color = 'bg-yellow-500';
        text = 'Medium';
    }
    
    strengthFill.style.width = score + '%';
    strengthFill.className = `h-full transition-all duration-300 ${color}`;
    strengthText.textContent = text;
}

function addCustomField(name = '', value = '') {
    const container = document.getElementById('customFieldsContainer');
    const id = customFieldCounter++;
    
    const div = document.createElement('div');
    div.className = 'flex gap-x-4 items-start';
    div.innerHTML = `
        <div class="flex-1">
            <input type="text" placeholder="Field Name" value="${name}" class="custom-field-name block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6" onchange="updateCustomFieldsJson()">
        </div>
        <div class="flex-1">
            <input type="text" placeholder="Value" value="${value}" class="custom-field-value block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-primary-600 sm:text-sm sm:leading-6" onchange="updateCustomFieldsJson()">
        </div>
        <button type="button" onclick="this.parentElement.remove(); updateCustomFieldsJson()" class="text-red-600 hover:text-red-500 p-2">
            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
            </svg>
        </button>
    `;
    
    container.appendChild(div);
}

function updateCustomFieldsJson() {
    const container = document.getElementById('customFieldsContainer');
    const fields = {};
    
    container.querySelectorAll('div.flex').forEach(row => {
        const name = row.querySelector('.custom-field-name').value.trim();
        const value = row.querySelector('.custom-field-value').value.trim();
        
        if (name) {
            fields[name] = value;
        }
    });
    
    document.getElementById('custom_fields').value = JSON.stringify(fields);
}

function loadCustomFields() {
    const input = document.getElementById('custom_fields');
    try {
        const fields = JSON.parse(input.value);
        for (const [name, value] of Object.entries(fields)) {
            addCustomField(name, value);
        }
    } catch (e) {
        console.error('Error parsing custom fields:', e);
    }
}
</script>
{% endblock %}