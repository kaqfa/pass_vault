{% extends "layouts/authenticated_content.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
{% endblock %}

{% block page_title %}{% if not is_create %}Edit Password{% else %}Add Password{% endif %}{% endblock %}

{% block authenticated_content %}
<div class="max-w-5xl mx-auto">
    <div class="mb-6">
        <h2 class="text-2xl font-bold tracking-tight">
            {% if not is_create %}Edit Item{% else %}Add Item{% endif %}
        </h2>
        <p class="text-muted-foreground">
            {% if not is_create %}Update the details of your vault item.{% else %}Add a new item to your vault.{% endif %}
        </p>
    </div>

    <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
        <form method="post" class="p-6 space-y-6" x-data="passwordFormApp()" @submit="submitForm($event)">
            {% csrf_token %}
            
            {% if errors.non_field_errors %}
                <div class="rounded-md bg-destructive/15 p-3 text-sm text-destructive">
                    {% for error in errors.non_field_errors %}
                        <p>{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="grid gap-6 lg:grid-cols-2 lg:gap-12">
                <!-- Left Column: Core Details -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold border-b pb-2">Core Details</h3>
                    
                    <!-- Name -->
                    <div class="space-y-2">
                        <label for="title" class="text-sm font-medium leading-none">Name</label>
                        <input type="text" name="title" id="title" value="{% firstof form_data.title password.title '' %}" placeholder="e.g. Gmail" class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm focus-visible:ring-2 focus-visible:ring-ring disabled:opacity-50" required>
                        {% if errors.title %}<p class="text-sm font-medium text-destructive">{{ errors.title.0 }}</p>{% endif %}
                    </div>

                    <!-- Username -->
                    <div class="space-y-2">
                        <label for="username" class="text-sm font-medium leading-none">Username</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-muted-foreground"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            </div>
                            <input type="text" name="username" id="username" value="{% firstof form_data.username password.username '' %}" placeholder="user@example.com" class="flex h-10 w-full rounded-md border border-input bg-transparent pl-9 px-3 py-2 text-sm focus-visible:ring-2 focus-visible:ring-ring disabled:opacity-50">
                        </div>
                        {% if errors.username %}<p class="text-sm font-medium text-destructive">{{ errors.username.0 }}</p>{% endif %}
                    </div>

                    <!-- Password -->
                    <div class="space-y-2">
                        <label for="password" class="text-sm font-medium leading-none">Password</label>
                        <div class="flex gap-2" x-data="{ show: false }">
                            <div class="relative flex-1">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-muted-foreground"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                </div>
                                <input :type="show ? 'text' : 'password'" name="password" id="password" value="" class="flex h-10 w-full rounded-md border border-input bg-transparent pl-9 pr-10 px-3 py-2 text-sm focus-visible:ring-2 focus-visible:ring-ring disabled:opacity-50" {% if is_create %}required{% endif %} placeholder="{% if not is_create %}Leave blank to keep current{% endif %}">
                                <button type="button" @click="show = !show" class="absolute inset-y-0 right-0 pr-3 flex items-center text-muted-foreground hover:text-foreground">
                                    <svg x-show="!show" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                                    <svg x-show="show" x-cloak xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                </button>
                            </div>
                            <button type="button" @click="generatePassword" class="inline-flex items-center justify-center rounded-md text-sm font-medium border border-input bg-background h-10 px-4 py-2 hover:bg-accent hover:text-accent-foreground">Generate</button>
                        </div>
                        {% if errors.password %}<p class="text-sm font-medium text-destructive">{{ errors.password.0 }}</p>{% endif %}
                    </div>

                    <!-- URL -->
                    <div class="space-y-2">
                        <label for="url" class="text-sm font-medium leading-none">URL</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-muted-foreground"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                            </div>
                            <input type="url" name="url" id="url" value="{% firstof form_data.url password.url '' %}" placeholder="https://example.com" class="flex h-10 w-full rounded-md border border-input bg-transparent pl-9 px-3 py-2 text-sm focus-visible:ring-2 focus-visible:ring-ring disabled:opacity-50">
                        </div>
                        {% if errors.url %}<p class="text-sm font-medium text-destructive">{{ errors.url.0 }}</p>{% endif %}
                    </div>

                    <!-- Group & Favorite -->
                     <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="group_id" class="text-sm font-medium leading-none">Group</label>
                            <select name="group_id" id="group_id" class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm focus-visible:ring-2 focus-visible:ring-ring disabled:opacity-50">
                                {% for group in user_groups %}
                                     <option value="{{ group.pk }}" {% if form_data.group_id == group.pk|stringformat:"s" or password.group.pk == group.pk %}selected{% endif %}>{{ group.name }}</option>
                                {% endfor %}
                            </select>
                            {% if errors.group_id %}<p class="text-sm font-medium text-destructive">{{ errors.group_id.0 }}</p>{% endif %}
                        </div>
                         <div class="flex items-end pb-2">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" name="is_favorite" id="is_favorite" {% if form_data.is_favorite or password.is_favorite %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                                <label for="is_favorite" class="text-sm font-medium leading-none">Mark as Favorite</label>
                            </div>
                         </div>
                    </div>
                </div>

                <!-- Right Column: Extended Details -->
                <div class="space-y-6">
                    <h3 class="text-lg font-semibold border-b pb-2">Additional Info</h3>

                    <!-- Tags -->
                    <div class="space-y-2">
                        <label for="tags" class="text-sm font-medium leading-none">Tags</label>
                        <input type="text" name="tags" id="tags" value="{% if form_data.tags %}{{ form_data.tags|join:', ' }}{% else %}{{ tags_str|default:'' }}{% endif %}" placeholder="work, social, finance" class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm focus-visible:ring-2 focus-visible:ring-ring disabled:opacity-50">
                        <p class="text-[0.8rem] text-muted-foreground">Comma separated tags.</p>
                    </div>

                    <!-- Notes (Markdown) -->
                    <div class="space-y-2">
                        <label for="notes" class="text-sm font-medium leading-none">Notes</label>
                        <textarea name="notes" id="notes" class="hidden">{% firstof form_data.notes password.notes '' %}</textarea>
                        {% if errors.notes %}<p class="text-sm font-medium text-destructive">{{ errors.notes.0 }}</p>{% endif %}
                    </div>

                    <!-- Custom Fields (Dynamic) -->
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                             <label class="text-sm font-medium leading-none">Custom Fields</label>
                             <button type="button" @click="addCustomField" class="text-xs text-primary hover:underline flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>
                                Add Field
                             </button>
                        </div>
                        
                        <!-- Hidden Input to Serialize Data -->
                        <input type="hidden" name="custom_fields" :value="JSON.stringify(customFieldsObject)">

                        <div class="space-y-2">
                            <template x-for="(field, index) in customFields" :key="index">
                                <div class="flex gap-2 items-start">
                                    <input type="text" x-model="field.key" placeholder="Key (e.g. WiFi Code)" class="flex h-9 w-1/3 rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm focus-visible:ring-1 focus-visible:ring-ring">
                                    <input type="text" x-model="field.value" placeholder="Value" class="flex h-9 w-2/3 rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm focus-visible:ring-1 focus-visible:ring-ring">
                                    <button type="button" @click="removeCustomField(index)" class="h-9 w-9 inline-flex items-center justify-center rounded-md text-muted-foreground hover:bg-destructive/10 hover:text-destructive">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                                    </button>
                                </div>
                            </template>
                             <p x-show="customFields.length === 0" class="text-sm text-muted-foreground italic">No custom fields added.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-end gap-2 pt-6 border-t mt-6">
                <a href="{% url 'passwords:list' %}" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium border border-input bg-background h-10 px-4 py-2 hover:bg-accent hover:text-accent-foreground">Cancel</a>
                <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium bg-primary text-primary-foreground h-10 px-4 py-2 hover:bg-primary/90">
                    {% if not is_create %}Update Password{% else %}Save Password{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function passwordFormApp() {
        return {
            customFields: [], // Array of {key, value}
            
            get customFieldsObject() {
                // Convert array back to object for submission
                const obj = {};
                this.customFields.forEach(f => {
                    if (f.key.trim()) {
                        obj[f.key.trim()] = f.value;
                    }
                });
                return obj;
            },

            init() {
                // Initialize Markdown Editor
                new EasyMDE({ 
                    element: document.getElementById('notes'),
                    spellChecker: false,
                    status: false,
                    toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "preview"],
                    minHeight: "150px"
                });

                // Initialize Custom Fields from Context
                const initialData = {{ custom_fields_str|default:"{}"|safe }};
                this.customFields = Object.entries(initialData).map(([key, value]) => ({ key, value }));
            },

            addCustomField() {
                this.customFields.push({ key: '', value: '' });
            },

            removeCustomField(index) {
                this.customFields.splice(index, 1);
            },

            async generatePassword() {
                try {
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    const formData = new FormData();
                    formData.append('length', 16);
                    formData.append('include_uppercase', 'true');
                    formData.append('include_lowercase', 'true');
                    formData.append('include_numbers', 'true');
                    formData.append('include_symbols', 'true');
                    formData.append('exclude_ambiguous', 'true');

                    const response = await fetch('{% url "passwords:ajax_generate" %}', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken
                        },
                        body: formData
                    });
                    
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('password').value = data.password;
                        // Also update Alpine model if bound (though we use value="" on input)
                    } else {
                        console.error('Generation failed:', data);
                    }
                } catch(e) { 
                    console.error('Password generation error:', e);
                    alert('Failed to generate password. Please try again.');
                }
            },
            
            submitForm(e) {
                // EasyMDE sync handled automatically on submit usually, but good to know
            }
        }
    }
</script>
{% endblock %}