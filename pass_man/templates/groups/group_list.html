{% extends "layouts/authenticated_content.html" %}
{% load static %}

{% block page_title %}Groups{% endblock %}

{% block authenticated_content %}
<div x-data="groupListApp()">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold tracking-tight text-foreground">Groups</h1>
            <p class="text-muted-foreground mt-1">Manage your password groups and team sharing</p>
        </div>
        <button @click="showCreateModal = true" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
            Create Group
        </button>
    </div>

    <!-- Stats Row -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-4">
            <div class="flex items-center gap-4">
                <div class="p-2 bg-blue-100/50 text-blue-600 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-muted-foreground">Total Groups</p>
                    <p class="text-2xl font-bold">{{ stats.total_groups }}</p>
                </div>
            </div>
        </div>

        <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-4">
            <div class="flex items-center gap-4">
                <div class="p-2 bg-purple-100/50 text-purple-600 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-muted-foreground">Shared Groups</p>
                    <p class="text-2xl font-bold">{{ stats.shared_groups }}</p>
                </div>
            </div>
        </div>

        <div class="rounded-lg border bg-card text-card-foreground shadow-sm p-4">
            <div class="flex items-center gap-4">
                <div class="p-2 bg-green-100/50 text-green-600 rounded-lg">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                </div>
                <div>
                    <p class="text-sm font-medium text-muted-foreground">Total Passwords</p>
                    <p class="text-2xl font-bold">{{ stats.total_passwords }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="rounded-lg border bg-card text-card-foreground shadow-sm mb-6">
        <div class="p-4 flex flex-col sm:flex-row gap-4">
            <div class="relative flex-1">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <input
                    type="search"
                    placeholder="Search groups..."
                    x-model="searchQuery"
                    class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 pl-9 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
                />
            </div>
            <select x-model="filterType" class="flex h-9 w-full sm:w-[180px] rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50">
                <option value="">All Types</option>
                <option value="owned">Owned</option>
                <option value="shared">Shared</option>
                <option value="joined">Joined</option>
            </select>
        </div>
    </div>

    <!-- Groups Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <template x-for="group in filteredGroups" :key="group.id">
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm hover:shadow-md transition-shadow cursor-pointer" @click="viewGroup(group.id)">
                <div class="p-6">
                    <!-- Card Header -->
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-primary/10 text-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2Z"/></svg>
                            </div>
                            <div>
                                <h3 class="font-semibold leading-none tracking-tight" x-text="group.name"></h3>
                                <p class="text-sm text-muted-foreground mt-1" x-text="group.owner"></p>
                            </div>
                        </div>
                         <!-- Dropdown Menu Trigger (Mock) -->
                        <div class="relative" x-data="{ open: false }" @click.stop>
                             <button @click="open = !open" @click.outside="open = false" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-8 w-8">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                            </button>
                            <div x-show="open" x-transition class="absolute right-0 top-8 z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md">
                                <button @click="editGroup(group.id)" class="relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-accent hover:text-accent-foreground w-full text-left">
                                     Edit
                                </button>
                                <button @click="manageMembers(group.id)" class="relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-accent hover:text-accent-foreground w-full text-left">
                                    Manage Members
                                </button>
                                <div class="h-px bg-muted my-1"></div>
                                <button @click="deleteGroup(group.id)" class="relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-destructive hover:text-destructive-foreground w-full text-left text-destructive">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <p class="text-sm text-muted-foreground mb-4 line-clamp-2 h-10" x-text="group.description || 'No description'"></p>

                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-2 text-center border-t border-b py-3 mb-4">
                        <div>
                            <p class="text-lg font-semibold" x-text="group.password_count"></p>
                            <p class="text-xs text-muted-foreground">Passwords</p>
                        </div>
                        <div>
                            <p class="text-lg font-semibold" x-text="group.member_count"></p>
                            <p class="text-xs text-muted-foreground">Members</p>
                        </div>
                        <div>
                            <p class="text-lg font-semibold" x-text="group.shared_count"></p>
                            <p class="text-xs text-muted-foreground">Shared</p>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div class="flex gap-2 items-center text-xs">
                        <template x-for="tag in group.tags" :key="tag">
                            <span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80" x-text="tag"></span>
                        </template>
                         <span x-show="group.type === 'owned'" class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-primary/10 text-primary hover:bg-primary/20">Owned</span>
                        <span x-show="group.type === 'shared'" class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-purple-100 text-purple-700 hover:bg-purple-200">Shared</span>
                    </div>

                    <!-- Last Updated -->
                    <p class="text-xs text-muted-foreground mt-4" x-text="'Last updated ' + group.last_updated"></p>
                </div>
            </div>
        </template>

        <!-- Create New Group Card -->
        <div
            class="rounded-lg border border-dashed bg-card text-card-foreground shadow-sm hover:border-primary/50 cursor-pointer flex flex-col items-center justify-center min-h-[300px] transition-colors"
            @click="showCreateModal = true"
        >
             <div class="flex flex-col items-center justify-center p-6 text-muted-foreground hover:text-primary transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-12 w-12 mb-2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                <p class="font-medium">Create New Group</p>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div x-show="filteredGroups.length === 0 && !searchQuery" class="text-center py-12" x-cloak>
         <div class="flex flex-col items-center justify-center">
            <div class="bg-muted/50 p-4 rounded-full mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-12 w-12 text-muted-foreground"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2Z"/></svg>
            </div>
            <h3 class="text-lg font-semibold">No groups yet</h3>
            <p class="text-muted-foreground mt-2 mb-4">Create your first group to start organizing your passwords</p>
            <button @click="showCreateModal = true" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                Create Group
            </button>
        </div>
    </div>

    <!-- No Search Results -->
    <div x-show="filteredGroups.length === 0 && searchQuery" class="text-center py-12" x-cloak>
        <div class="flex flex-col items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-12 w-12 text-muted-foreground mb-4"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            <h3 class="text-lg font-semibold">No groups found</h3>
            <p class="text-muted-foreground mt-2">Try adjusting your search or filters</p>
        </div>
    </div>

    <!-- Create Group Modal (Overlay) -->
    <div x-show="showCreateModal" style="display: none;" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" x-transition.opacity>
        <div class="bg-background rounded-lg shadow-lg w-full max-w-md p-6 relative" @click.outside="showCreateModal = false" x-transition.scale>
            <button @click="showCreateModal = false" class="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><line x1="18" x2="6" y1="6" y2="18"></line><line x1="6" x2="18" y1="6" y2="18"></line></svg>
                <span class="sr-only">Close</span>
            </button>
            <div class="flex flex-col space-y-1.5 text-center sm:text-left">
                <h2 class="text-lg font-semibold leading-none tracking-tight">Create New Group</h2>
                <p class="text-sm text-muted-foreground">Create a new group to organize your passwords.</p>
            </div>
            <form method="post" action="{% url 'groups:create' %}" class="mt-4 space-y-4">
                 {% csrf_token %}
                 <div class="space-y-2">
                    <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Group Name</label>
                    <input type="text" name="name" required placeholder="e.g., Team Passwords" class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                </div>
                 <div class="space-y-2">
                    <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Description</label>
                    <textarea name="description" placeholder="Describe the purpose..." class="flex min-h-[80px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"></textarea>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" @click="showCreateModal = false" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">Cancel</button>
                    <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">Create Group</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function groupListApp() {
    return {
        showCreateModal: false,
        searchQuery: '',
        filterType: '',
        groups: {{ groups_json|safe }},

        get filteredGroups() {
            return this.groups.filter(group => {
                const matchesSearch = !this.searchQuery ||
                    group.name.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                    (group.description && group.description.toLowerCase().includes(this.searchQuery.toLowerCase()));

                const matchesType = !this.filterType || group.type === this.filterType;

                return matchesSearch && matchesType;
            });
        },

        viewGroup(groupId) {
            window.location.href = `/groups/${groupId}/`;
        },

        editGroup(groupId) {
            window.location.href = `/groups/${groupId}/edit/`;
        },

        manageMembers(groupId) {
            window.location.href = `/groups/${groupId}/members/`;
        },

        deleteGroup(groupId) {
            if (confirm('Are you sure you want to delete this group? This action cannot be undone.')) {
                // Delete group logic - for now just redirect or post
                 const form = document.createElement('form');
                 form.method = 'POST';
                 form.action = `/groups/${groupId}/delete/`;
                 const csrf = document.createElement('input');
                 csrf.type = 'hidden';
                 csrf.name = 'csrfmiddlewaretoken';
                 csrf.value = '{{ csrf_token }}';
                 form.appendChild(csrf);
                 document.body.appendChild(form);
                 form.submit();
            }
        }
    }
}
</script>
{% endblock %}