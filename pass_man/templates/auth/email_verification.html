{% extends "base.html" %}

{% block title %}Verify Email - Pass-Man{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center p-8">
    <div class="w-full max-w-md">
        <div class="text-center mb-8">
            <sl-icon name="mail-unread" style="font-size: 4rem; color: var(--sl-color-primary-600);"></sl-icon>
        </div>

        <sl-card class="w-full">
            <div slot="header">
                <h2 class="text-xl font-semibold">Verify Your Email</h2>
                <p class="text-sm text-gray-500 mt-1">We've sent a verification link to your email</p>
            </div>

            <div class="text-center space-y-4">
                <div class="p-4 bg-primary-50 rounded-lg">
                    <p class="text-lg font-medium text-primary-900">{{ user.email }}</p>
                    <p class="text-sm text-primary-700 mt-1">Check your inbox and click the verification link</p>
                </div>

                <div class="space-y-2 text-sm text-gray-600">
                    <p>Didn't receive the email?</p>
                    <ul class="text-left space-y-1 ml-4">
                        <li>• Check your spam/junk folder</li>
                        <li>• Make sure the email address is correct</li>
                        <li>• Wait a few minutes for delivery</li>
                    </ul>
                </div>

                {% if messages %}
                    {% for message in messages %}
                        <sl-alert type="{% if message.tags == 'error' %}danger{% else %}success{% endif %}" open>
                            <sl-icon name="{% if message.tags == 'error' %}exclamation-triangle{% else %}check-circle{% endif %}" slot="icon"></sl-icon>
                            {{ message }}
                        </sl-alert>
                    {% endfor %}
                {% endif %}

                <form method="post" action="{% url 'users:resend_verification' %}" class="pt-4">
                    {% csrf_token %}
                    <sl-button type="submit" variant="default" outline>
                        <sl-icon name="refresh" slot="prefix"></sl-icon>
                        Resend Verification Email
                    </sl-button>
                </form>
            </div>

            <div slot="footer">
                <div class="text-center space-y-2">
                    <p class="text-sm text-gray-500">
                        Already verified?
                        <a href="{% url 'users:login' %}" class="text-primary-600 hover:text-primary-700 font-medium">Sign In</a>
                    </p>
                    <p class="text-sm text-gray-500">
                        Wrong email?
                        <a href="{% url 'users:logout' %}" class="text-primary-600 hover:text-primary-700">Sign Out</a>
                    </p>
                </div>
            </div>
        </sl-card>

        <!-- Auto-refresh checker -->
        <div x-data="{
            checkVerified: false,
            intervalId: null,

            init() {
                // Check verification status every 30 seconds
                this.intervalId = setInterval(async () => {
                    try {
                        const response = await fetch('{% url "users:check_verification" %}', {
                            method: 'GET',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.verified) {
                                showToast('Email verified successfully! Redirecting...', 'success');
                                setTimeout(() => {
                                    window.location.href = '{% url "users:login" %}';
                                }, 1500);
                            }
                        }
                    } catch (error) {
                        // Silently fail
                    }
                }, 30000);
            },

            destroy() {
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                }
            }
        }" x-init="init()" x-on:unload="destroy()"></div>
    </div>
</div>

<style>
    .space-y-1 > * + * {
        margin-top: var(--sl-spacing-x-small);
    }

    .space-y-2 > * + * {
        margin-top: var(--sl-spacing-small);
    }

    .space-y-4 > * + * {
        margin-top: var(--sl-spacing-medium);
    }

    .bg-primary-50 { background-color: var(--sl-color-primary-50); }
    .text-primary-700 { color: var(--sl-color-primary-700); }
    .text-primary-900 { color: var(--sl-color-primary-900); }
</style>
{% endblock %}