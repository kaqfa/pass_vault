{% extends "base.html" %}

{% block title %}Set New Password - Pass-Man{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center p-8 bg-background">
    <div class="w-full max-w-md">
        <div class="text-center mb-8">
             <div class="flex items-center justify-center mb-4">
                <div class="flex h-16 w-16 items-center justify-center rounded-2xl bg-primary/10 text-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><rect x="8" y="10" width="8" height="5" rx="1"/></svg>
                </div>
            </div>
            <h1 class="text-2xl font-bold tracking-tight">Pass-Man</h1>
        </div>

        <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
            <div class="flex flex-col space-y-1.5 p-6 pb-2">
                {% if valid_link %}
                    <h2 class="text-xl font-semibold leading-none tracking-tight">Set New Password</h2>
                    <p class="text-sm text-muted-foreground mt-1">Enter your new password below</p>
                {% else %}
                     <h2 class="text-xl font-semibold leading-none tracking-tight text-destructive">Invalid Link</h2>
                {% endif %}
            </div>

            <div class="p-6 pt-2">
                {% if valid_link %}
                <form method="post" class="space-y-4" x-data="{ passwordStrength: 0 }">
                    {% csrf_token %}

                    {% if errors.non_field_errors %}
                        <div class="rounded-md bg-destructive/15 p-3 text-sm text-destructive">
                            {% for error in errors.non_field_errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- New Password Field -->
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="new_password">
                            New Password
                        </label>
                        <input
                            type="password"
                            id="new_password"
                            name="new_password"
                            placeholder="Enter your new password"
                            required
                            class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                            @input="passwordStrength = checkPasswordStrength($el.value)"
                        />

                        <!-- Password Strength Indicator -->
                        <div class="space-y-1">
                            <div class="flex gap-1 h-1.5 overflow-hidden rounded-full bg-secondary">
                                <div class="flex-1 transition-all" :class="passwordStrength > 0 ? 'bg-destructive' : 'bg-transparent'"></div>
                                <div class="flex-1 transition-all" :class="passwordStrength > 1 ? 'bg-yellow-500' : 'bg-transparent'"></div>
                                <div class="flex-1 transition-all" :class="passwordStrength > 2 ? 'bg-blue-500' : 'bg-transparent'"></div>
                                <div class="flex-1 transition-all" :class="passwordStrength > 3 ? 'bg-green-500' : 'bg-transparent'"></div>
                            </div>
                            <p class="text-xs text-muted-foreground">Use 8+ characters with mixed case, numbers, and symbols</p>
                        </div>

                        {% if errors.new_password %}
                             <p class="text-sm font-medium text-destructive">{{ errors.new_password }}</p>
                        {% endif %}
                    </div>

                    <!-- Confirm Password Field -->
                    <div class="space-y-2">
                        <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70" for="confirm_password">
                            Confirm New Password
                        </label>
                        <input
                            type="password"
                            id="confirm_password"
                            name="confirm_password"
                            placeholder="Confirm your new password"
                            required
                            class="flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                        />
                        {% if errors.confirm_password %}
                            <p class="text-sm font-medium text-destructive">{{ errors.confirm_password }}</p>
                        {% endif %}
                    </div>

                    <!-- Submit Button -->
                     <button type="submit" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full">
                        Set New Password
                    </button>
                </form>
                {% else %}
                <div class="rounded-md bg-destructive/15 p-4 text-sm text-destructive mb-4">
                    <div class="flex items-center gap-2 font-semibold mb-1">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>
                        Invalid Link
                    </div>
                    The password reset link was invalid, possibly because it has already been used or has expired.
                </div>
                <div class="text-center">
                    <a href="{% url 'users:password_reset' %}" class="text-primary hover:underline relative text-sm font-medium">
                        Request a new password reset
                    </a>
                </div>
                {% endif %}
            </div>

            <div class="p-6 pt-0 border-t mt-4 flex justify-center">
                 <a href="{% url 'users:login' %}" class="text-sm text-muted-foreground hover:text-foreground pt-4">
                    ‚Üê Back to Sign In
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function checkPasswordStrength(password) {
    let strength = 0;
    if (password.length >= 8) strength++;
    if (password.length >= 12) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength++;
    return Math.min(strength, 4);
}
</script>
{% endblock %}